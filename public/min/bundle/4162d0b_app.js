"use strict";var app=angular.module("trackr",["ngResource","ngRoute","ui.router","ngCookies"]);app.config(["$httpProvider","$routeProvider","$locationProvider","$urlRouterProvider","$stateProvider",function(a,b,c,d,e){d.when("","/nes"),e.state("login",{url:"/login",templateUrl:"app/account/login.html",controller:"LoginCtrl"}).state("register",{url:"/register",templateUrl:"app/account/register.html",controller:"RegisterCtrl"}).state("admin",{url:"/admin",templateUrl:"app/admin/index.html",controller:"AdminCtrl",resolve:{user:validateUser}}).state("user",{url:"/user/:userName",templateUrl:"app/user/user.html",controller:"UserCtrl",resolve:{stats:["UserGamesStatsService","$stateParams",function(a,b){var c=a.query({userName:b.userName});return c.$promise}]}}).state("user.list",{url:"/:consoleName",templateUrl:"app/game/masterlist.html",controller:"UserListCtrl",resolve:{gameResponse:["UserGamesService","$stateParams",function(a,b){var c=a.get({userName:b.userName,consoleName:b.consoleName});return c.$promise}]}}).state("console",{"abstract":!0,url:"/:consoleName",template:"<ui-view/>"}).state("console.region",{url:"/:regionName",templateUrl:"app/game/regionlist.html",controller:"GameRegionCtrl"}).state("console.region.subregion",{url:"/:subRegionName",templateUrl:"app/game/masterlist.html",controller:"GameListCtrl"}).state("game",{url:"/:consoleName/:regionName/:subRegionName/:gameName",templateUrl:"app/game/game.html",controller:"GameDetailsCtrl"})}]);var validateUser=["$q","$http","$location","$timeout",function(a,b,c,d){var e=a.defer();return b.get("/api/loggedin").success(function(a){a.status?d(function(){e.resolve(a.user)},0):(d(function(){e.reject()},0),c.path("/nes"))}),e.promise}];app.factory("UserGamesStatsService",["$resource",function(a){return a("/api/user/:userName")}]),app.factory("UserGamesService",["$resource",function(a){return a("/api/user/:userName/:consoleName")}]),app.factory("GamesService",["$resource",function(a){return a("/api/:consoleName/:regionName/:subRegionName")}]),app.factory("GameDetailsService",["$resource",function(a){return a("/api/:consoleName/:regionName/:subRegionName/:gameName")}]),app.constant("consoles",[{id:"nes",name:"NES"},{id:"snes",name:"SNES"},{id:"n64",name:"GB"},{id:"n64",name:"N64"},{id:"gc",name:"GC"},{id:"wii",name:"Wii"},{id:"wiiu",name:"WiiU"},{id:"gw",name:"G&W"}]),app.constant("baseRegions",[{id:"pal-b",name:"PAL-B",selected:!0,regions:[{id:"scn",name:"SCN",selected:!0},{id:"noe",name:"NOE",selected:!1},{id:"esp",name:"ESP",selected:!1},{id:"fra",name:"FRA",selected:!1},{id:"hol",name:"HOL",selected:!1}]},{id:"pal-a",name:"PAL-A",selected:!1,regions:[{id:"ukv",name:"UKV",selected:!0},{id:"ita",name:"ITA",selected:!1},{id:"aus",name:"AUS",selected:!1}]},{id:"ntsc",name:"NTSC",selected:!1,regions:[{id:"ntsc",name:"NTSC",selected:!0}]},{id:"ntsc-j",name:"NTSC-J",selected:!1,regions:[{id:"ntsc-j",name:"NTSC-J",selected:!0}]}]),_.mixin(_.str.exports()),app.controller("IndexCtrl",["$scope","$http","consoles",function(a,b,c){a.consoles=c,console.log("index"),a.loggedInUser={},a.isLoggedIn=function(){return!_.isEmpty(a.loggedInUser)},b.get("/api/user/details").success(function(b){_.isEmpty(b)||(a.loggedInUser=b)}),a.showAdminLink=function(){return _.contains(a.loggedInUser.roles,"a")},a.$on("userLog",function(b,c){console.log(b),console.log("user "+JSON.stringify(c)),a.loggedInUser=c})}]),app.controller("LoginCtrl",["$scope","$location","$http",function(a,b,c){console.log("loginctrl"),a.credentials={},a.validateCredentials=function(d){c.post("/api/login",d).success(function(c){c.success?(a.$emit("userLog",c.user),b.path("/user/"+c.user.username)):a.errorMessage=c.message}).error(function(a){console.log(a)})},a.validateFields=function(){return a.loginForm.$valid}}]),app.controller("RegisterCtrl",["$scope","$location","$http",function(a,b,c){console.log("registerctrl"),a.credentials={email:"",username:"",password:""},a.registerCredentials=function(){c.post("/api/register",a.credentials).success(function(c){console.log(JSON.stringify(c)),c.success?(a.$emit("userLog",c.user),b.path("/user/"+c.user.username)):a.errorMessage=c.message}).error(function(b,c){c===409&&(a.errorMessage="Användarnamnet upptaget, välj ett annat.")})},a.validateFields=function(){return a.regForm.$valid}}]),app.controller("LogoutCtrl",function(a,b,c,d){a.logout=function(){c.post("/api/logout").success(function(){a.$emit("userLog",{}),b.path("/nes")})}}),app.controller("AdminCtrl",["$scope","$http","$location","consoles","baseRegions","user",function(a,b,c,d,e,f){a.user=f,a.consoles=d,a.regions=e,a.game={type:"game",regions:{},attr:{extras:[]}},a.postMessage="",a.attributes=[{id:"c",longName:"Kassett",selected:!0},{id:"i",longName:"Manual",selected:!0},{id:"b",longName:"Kartong",selected:!0}],a.currentExtra="",a.currentRegions={main:e[0],sub:e[0].regions[0]},a.regionChanged=function(){a.currentRegions.sub=a.currentRegions.main.regions[0]},a.handleExtra=function(b){_.contains(a.game.attr.extras,b)?a.game.attr.extras.splice(_.indexOf(a.game.attr.extras,b),1):a.game.attr.extras.push({name:b}),a.currentExtra=""},a.addGame=function(){a.game.attr.common=_.pluck(_.filter(a.attributes,function(a){return a.selected}),"id"),a.game.regions.main=a.currentRegions.main.id,a.game.regions.sub=[a.currentRegions.sub.id],console.log(angular.toJson(a.game)),b.post("/api/newgame",angular.toJson(a.game)).success(function(b){a.postMessage="Spel sparat",a.game={type:"game",console:d[0].id,regions:{},attr:{extras:[]}}}).error(function(a){console.log("nej nej NEJ")})},a.validateFields=function(){return a.addGameForm.$valid}}]),app.controller("GameDetailsCtrl",["$scope","$stateParams","GameDetailsService",function(a,b,c){console.log("gamedetailsctrl"),a.game={},c.get({consoleName:b.consoleName,regionName:b.regionName,subRegionName:b.subRegionName,gameName:b.gameName},function(b){a.game.content=b.name})}]),app.controller("GameListCtrl",["$scope","$location","$stateParams","$http","$timeout","GamesService","baseRegions",function(a,b,c,d,e,f,g){console.log("gamelistctrl"),a.currentRegion.subregion=c.subRegionName.length>0?_.find(a.currentRegion.region.regions,function(a){return a.id===c.subRegionName}):g[0].regions[0],a.selected={},a.initialResult=[],f.get({consoleName:c.consoleName,regionName:c.regionName,subRegionName:a.currentRegion.subregion.id}).$promise.then(function(b){a.initialResult=b.games,a.games=b.games,a.loggedIn=b.loggedIn}),a.$watch("consoleName",function(b){b.length&&a.$emit("consoleChanged",b)}),a.idEditing=!1,a.editGame=function(b){if(!a.loggedIn)return;a.isEditing=!a.isEditing,a.isEditing?a.selected=JSON.parse(angular.toJson({id:b.id,item:b.item,attr:b.attr})):a.selected.id!==b.id?(a.selected=JSON.parse(angular.toJson({id:b.id,item:b.item,attr:b.attr})),a.isEditing=!0):a.selected={}},a.attrChanged=function(b){a.willRemove=_.every(_.pluck(b,"status"),function(a){return!a})&&!a.selected.attr.isNew?!0:!1},a.updateGame=function(b){var e=a.selected,f={common:_.pluck(e.attr.common,"status"),extras:_.pluck(e.attr.extras,"status"),note:e.attr.note};e.attr.isNew?d.post("/api/user/add",{id:e.id,console:c.consoleName,attr:f}).success(function(){b.attr=e.attr,b.attr.isNew=!1,a.editGame(b)}).error(function(){console.log("HIELP")}):_.every(f.common,function(a){return!a})&&!a.selected.attr.isNew?(console.log("vill ta bort "+e.item),a.$emit("gameRemoved",a.consoleName),d.post("/api/user/remove",{item:e.item}).success(function(){a.editGame(b)}).error(function(){console.log("HIELP")})):d.post("/api/user/update",{item:e.item,attr:f}).success(function(){b.attr=e.attr,b.attr.isComplete=_.every(_.pluck(b.attr.common,"status"))&&(b.attr.extras.length?_.every(_.pluck(b.attr.extras,"status")):!0),console.log(b.attr.isComplete),a.editGame(b)}).error(function(){console.log("HIELP")})},a.isDirty=function(b){return angular.toJson(b)!==angular.toJson(a.selected.attr)};var h=[];a.search=function(){if(a.q===undefined)return;if(a.q.length===0){a.games=a.initialResult,a.showQ=!1;return}var b=_.filter(h,function(b){return _.any(b.tags,function(b){return _(b).startsWith(a.q)})});b.length===0?j(a):a.games=b};var i=function(a){a.$apply(function(){k(a)})},j=_.debounce(i,1e3),k=function(a){a.q!==undefined&&(console.log("eller så söker vi lite..."),e(function(){a.pendingPromise&&e.cancel(a.pendingPromise),a.pendingPromise=d.get("/api/search/"+c.consoleName+"?q="+a.q.substring(0,3).toLowerCase()),a.pendingPromise.success(function(b){h=b.games,a.games=_.filter(b.games,function(b){return _.any(b.tags,function(b){return _(b).startsWith(a.q.toLowerCase())})}),a.showQ=!0,console.log("och nu kom resultatet")})},0))}}]),app.controller("GameRegionCtrl",["$scope","$location","$stateParams","baseRegions",function(a,b,c,d){a.regions=d;if(c.regionName.length===0){b.path("/"+c.consoleName+"/"+a.regions[0].id+"/"+a.regions[0].regions[0].id).replace();return}a.consoleName=c.consoleName||"nes",a.currentRegion={region:c.regionName.length>0?_.find(d,function(a){return a.id===c.regionName}):d[0]},a.regionChanged=function(d){b.path("/"+c.consoleName+"/"+a.currentRegion.region.id+"/"+a.currentRegion.region.regions[0].id).replace()},a.subRegionChanged=function(d){b.path("/"+c.consoleName+"/"+a.currentRegion.region.id+"/"+a.currentRegion.subregion.id).replace()}}]),app.controller("UserCtrl",["$scope","$stateParams","stats",function(a,b,c){a.userName=b.userName,a.stats=c,a.$on("consoleChanged",function(b,c){a.selected=c}),a.$on("gameRemoved",function(b,c){console.log(_.where(a.stats,{console:c})[0]);var d=_.where(a.stats,{console:c})[0];d.count===1?a.stats.splice(_.indexOf(a.stats,d),1):count--})}]),app.controller("UserListCtrl",["$scope","$location","$stateParams","$http","$timeout","baseRegions","gameResponse",function(a,b,c,d,e,f,g){console.log("userlistctrl"),a.userName=c.userName,a.consoleName=c.consoleName||"nes",a.regionName=c.regionName||"scn",a.selected={},a.searchResult=[],a.games=g.games,a.loggedIn=g.loggedIn,a.$watch("consoleName",function(b){b.length&&a.$emit("consoleChanged",b)}),a.regions=f,a.currentRegion={region:_.find(a.regions,function(b){return b.id===a.regionName})},a.idEditing=!1,a.editGame=function(b){if(!a.loggedIn)return;a.isEditing=!a.isEditing,a.isEditing?a.selected=JSON.parse(angular.toJson({id:b.id,item:b.item,attr:b.attr})):a.selected.id!==b.id?(a.selected=JSON.parse(angular.toJson({id:b.id,item:b.item,attr:b.attr})),a.isEditing=!0):a.selected={}},a.attrChanged=function(b){a.willRemove=_.every(_.pluck(b,"status"),function(a){return!a})&&!a.selected.attr.isNew?!0:!1},a.updateGame=function(b){var e=a.selected,f={common:_.pluck(e.attr.common,"status"),extras:_.pluck(e.attr.extras,"status"),note:e.attr.note};e.attr.isNew?d.post("/api/user/add",{id:e.id,console:c.consoleName,attr:f}).success(function(){b.attr=e.attr,b.attr.isNew=!1,a.editGame(b)}).error(function(){console.log("HIELP")}):_.every(f.common,function(a){return!a})&&!a.selected.attr.isNew?(console.log("vill ta bort "+e.item),a.$emit("gameRemoved",a.consoleName),d.post("/api/user/remove",{item:e.item}).success(function(){a.userName!==undefined&&(b.isRemoved=!0,a.$emit("gameRemoved",a.consoleName)),a.editGame(b)}).error(function(){console.log("HIELP")})):d.post("/api/user/update",{item:e.item,attr:f}).success(function(){b.attr=e.attr,b.attr.isComplete=_.every(_.pluck(b.attr.common,"status"))&&(b.attr.extras.length?_.every(_.pluck(b.attr.extras,"status")):!0),console.log(b.attr.isComplete),a.editGame(b)}).error(function(){console.log("HIELP")})},a.isDirty=function(b){return angular.toJson(b)!==angular.toJson(a.selected.attr)};var h=[];a.search=function(){if(a.q===undefined)return;if(a.q.length===0){a.games=g.games,a.showQ=!1;return}var b=_.filter(h,function(b){return _.any(b.tags,function(b){return _(b).startsWith(a.q)})});b.length===0?j(a):a.games=b};var i=function(a){a.$apply(function(){k(a)})},j=_.debounce(i,1e3),k=function(a){a.q!==undefined&&(console.log("eller så söker vi lite..."),e(function(){a.pendingPromise&&e.cancel(a.pendingPromise),a.pendingPromise=d.get("/api/search/"+c.consoleName+"?q="+a.q.substring(0,3).toLowerCase()+"&r="+a.userName),a.pendingPromise.success(function(b){h=b.games,a.games=_.filter(b.games,function(b){return _.any(b.tags,function(b){return _(b).startsWith(a.q.toLowerCase())})}),a.showQ=!0,console.log("och nu kom resultatet")})},0))}}])